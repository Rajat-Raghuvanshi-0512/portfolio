import M from"./media-container.js";import{defineCustomElement as S}from"./utils/defineCustomElement.js";import{Window as c}from"./utils/server-safe-globals.js";import{fullscreenApi as r}from"./utils/fullscreenApi.js";import{constToCamel as m}from"./utils/stringUtils.js";import{mediaUIEvents as n}from"./media-chrome-html-element.js";const{MEDIA_PLAY_REQUEST:R,MEDIA_PAUSE_REQUEST:g,MEDIA_MUTE_REQUEST:I,MEDIA_UNMUTE_REQUEST:T,MEDIA_VOLUME_REQUEST:P,MEDIA_ENTER_FULLSCREEN_REQUEST:U,MEDIA_EXIT_FULLSCREEN_REQUEST:v,MEDIA_SEEK_REQUEST:A,MEDIA_PREVIEW_REQUEST:D,MEDIA_ENTER_PIP_REQUEST:Q,MEDIA_EXIT_PIP_REQUEST:L,MEDIA_PLAYBACK_RATE_REQUEST:b}=n;class u extends M{constructor(){super();this.associatedElements=[];const t={MEDIA_PLAY_REQUEST:()=>this.media.play(),MEDIA_PAUSE_REQUEST:()=>this.media.pause(),MEDIA_MUTE_REQUEST:()=>this.media.muted=!0,MEDIA_UNMUTE_REQUEST:()=>{const e=this.media;e.muted=!1,e.volume===0&&(e.volume=.25)},MEDIA_VOLUME_REQUEST:e=>{const i=this.media,a=e.detail;i.volume=a,a>0&&i.muted&&(i.muted=!1);try{c.localStorage.setItem("media-chrome-pref-volume",a.toString())}catch(s){}},MEDIA_ENTER_FULLSCREEN_REQUEST:()=>{const e=this.getRootNode();e.pictureInPictureElement&&e.exitPictureInPicture(),super[r.enter]()},MEDIA_EXIT_FULLSCREEN_REQUEST:()=>{this.getRootNode()[r.exit]()},MEDIA_ENTER_PIP_REQUEST:()=>{const e=this.getRootNode(),i=this.media;if(!e.pictureInPictureEnabled)return;e[r.element]&&e[r.exit](),i.requestPictureInPicture()},MEDIA_EXIT_PIP_REQUEST:()=>{const e=this.getRootNode();e.exitPictureInPicture&&e.exitPictureInPicture()},MEDIA_SEEK_REQUEST:e=>{const i=this.media,a=e.detail;(i.readyState>0||i.readyState===void 0)&&(i.currentTime=a)},MEDIA_PLAYBACK_RATE_REQUEST:e=>{this.media.playbackRate=e.detail},MEDIA_PREVIEW_REQUEST:e=>{const i=this.media,a=e.detail;if(i&&i.textTracks&&i.textTracks.length){let s=Array.prototype.find.call(i.textTracks,d=>d.label=="thumbnails");if(!s)return;if(!s.cues)return;let o=Array.prototype.find.call(s.cues,d=>d.startTime>=a);if(o){const d=new URL(o.text),[h,p,f,_]=d.hash.split("=")[1].split(",");this.propagateMediaState("mediaPreviewImage",d.href),this.propagateMediaState("mediaPreviewCoords",`${h},${p},${f},${_}`)}}}};Object.keys(t).forEach(e=>{const i=`_handle${m(e,!0)}`;this[i]=a=>{if(a.stopPropagation(),!this.media){console.warn("MediaController: No media available.");return}t[e](a,this.media)},this.addEventListener(n[e],this[i])}),this._mediaStatePropagators={"play,pause":()=>{this.propagateMediaState("mediaPaused",this.media.paused)},volumechange:()=>{const{muted:e,volume:i}=this.media;let a="high";i==0||e?a="off":i<.5?a="low":i<.75&&(a="medium"),this.propagateMediaState("mediaMuted",e),this.propagateMediaState("mediaVolume",i),this.propagateMediaState("mediaVolumeLevel",a)},[r.event]:()=>{const e=this.getRootNode()[r.element];this.propagateMediaState("mediaIsFullscreen",e==this)},"enterpictureinpicture,leavepictureinpicture":e=>{let i;e?i=e.type=="enterpictureinpicture":i=this.media==this.getRootNode().pictureInPictureElement,this.propagateMediaState("mediaIsPip",i)},"timeupdate,loadedmetadata":()=>{this.propagateMediaState("mediaCurrentTime",this.media.currentTime)},"durationchange,loadedmetadata":()=>{this.propagateMediaState("mediaDuration",this.media.duration)},ratechange:()=>{this.propagateMediaState("mediaPlaybackRate",this.media.playbackRate)}},this.associateElement(this)}mediaSetCallback(t){if(!super.mediaSetCallback(t))return;Object.keys(this._mediaStatePropagators).forEach(e=>{const i=e.split(","),a=this._mediaStatePropagators[e];i.forEach(s=>{const o=s==r.event?this.getRootNode():t;o.addEventListener(s,a)}),a()});try{const e=c.localStorage.getItem("media-chrome-pref-volume");e!==null&&(t.volume=e)}catch(e){console.debug("Error getting volume pref",e)}}mediaUnsetCallback(t){super.mediaUnsetCallback(t),Object.keys(this._mediaStatePropagators).forEach(e=>{const{events:i,handler:a}=this.mediaStatePropagators[e];i.forEach(s=>{const o=s==r.event?this.getRootNode():t;o.removeEventListener(s,a)})}),this.propagateMediaState("mediaPaused",!0)}propagateMediaState(t,e){E(this.children,t,e),E(this.associatedElements,t,e)}associateElement(t){this.associatedElements.push(t),Object.keys(n).forEach(e=>{t.addEventListener(n[e],this[`_handle${m(e,!0)}`])}),this.media&&E([t],"mediaPaused",this.media.paused)}unassociateElement(t){els=this.associatedElements;const e=els.indexOf(t);e>-1&&els.splice(e,1),Object.keys(n).forEach(i=>{t.addEventListener(n[i],this[`_handle${m(i,!0)}`])})}play(){this.dispatchMediaEvent(R)}pause(){this.dispatchMediaEvent(g)}get muted(){return!!(this.media&&this.media.muted)}set muted(t){const e=t?I:T;this.dispatchMediaEvent(e)}get volume(){const t=this.media;return t?t.volume:1}set volume(t){this.dispatchMediaEvent(P,{detail:t})}requestFullscreen(){this.dispatchMediaEvent(U)}exitFullscreen(){this.dispatchMediaEvent(v)}get currentTime(){const t=this.media;return t?t.currentTime:0}set currentTime(t){this.dispatchMediaEvent(A,{detail:t})}get playbackRate(){const t=this.media;return t?t.currentTime:1}set playbackRate(t){this.dispatchMediaEvent(b,{detail:t})}requestPictureInPicture(){this.dispatchMediaEvent(Q,{detail:time})}exitPictureInPicture(){this.dispatchMediaEvent(L,{detail:time})}requestPreview(t){this.dispatchMediaEvent(D,{detail:t})}}function E(l,t,e){Array.from(l).forEach(i=>{if(!i.children)return;const a=i.nodeName.toLowerCase();if(i.slot==="media")return;function s(){typeof i[t]!="undefined"&&(i[t]=e),E(i.children,t,e),i.shadowRoot&&E(i.shadowRoot.childNodes,t,e)}a.includes("-")&&!c.customElements.get(a)?c.customElements.whenDefined(a).then(s):s()})}S("media-controller",u);export default u;
