{"version":3,"file":"secrets.js","names":["cache","secrets","exists","fetchSecrets","Promise","resolve","client","fetch","then","Boolean","token","secretKey","enableSignedUrls","signingKeyId","signingKeyPrivate","saveSecrets","doc","_id","_type","createOrReplace","createSigningKeys","dataset","clientConfig","request","url","withCredentials","method","testSecrets","haveValidSigningKeys","res","data","id","e","console","error","testSecretsObservable","defer","observable"],"sources":["../../src/actions/secrets.ts"],"sourcesContent":["import {defer} from 'rxjs'\n\nimport client from '../clients/SanityClient'\nimport type {Secrets} from '../util/types'\n\nconst cache: {secrets: Secrets | null; exists: boolean} = {\n  secrets: null,\n  exists: false,\n}\n\nexport function fetchSecrets() {\n  if (cache.exists) {\n    return Promise.resolve(cache)\n  }\n\n  return client.fetch('*[_id == \"secrets.mux\"][0]').then((secrets: Secrets | null) => {\n    cache.exists = Boolean(secrets)\n    cache.secrets = {\n      token: secrets?.token || null,\n      secretKey: secrets?.secretKey || null,\n      enableSignedUrls: secrets?.enableSignedUrls || false,\n      signingKeyId: secrets?.signingKeyId || null,\n      signingKeyPrivate: secrets?.signingKeyPrivate || null,\n    }\n    return cache\n  })\n}\n\nexport function saveSecrets(\n  token: string,\n  secretKey: string,\n  enableSignedUrls: boolean,\n  signingKeyId: string,\n  signingKeyPrivate: string\n) {\n  const doc = {\n    _id: 'secrets.mux',\n    _type: 'mux.apiKey',\n    token,\n    secretKey,\n    enableSignedUrls,\n    signingKeyId,\n    signingKeyPrivate,\n  }\n\n  return client.createOrReplace(doc).then(() => {\n    cache.exists = true\n    cache.secrets = {\n      token,\n      secretKey,\n      enableSignedUrls,\n      signingKeyId,\n      signingKeyPrivate,\n    }\n    return cache.secrets\n  })\n}\n\nexport function createSigningKeys() {\n  const dataset = client.clientConfig.dataset\n  return client.request<{data: {private_key: string; id: string; created_at: string}}>({\n    url: `/addons/mux/signing-keys/${dataset}`,\n    withCredentials: true,\n    method: 'POST',\n  })\n}\n\nexport function testSecrets() {\n  const dataset = client.clientConfig.dataset\n  return client.request<{status: boolean}>({\n    url: `/addons/mux/secrets/${dataset}/test`,\n    withCredentials: true,\n    method: 'GET',\n  })\n}\n\nexport async function haveValidSigningKeys(signingKeyId: string, signingKeyPrivate: string) {\n  if (!(signingKeyId && signingKeyPrivate)) {\n    return false\n  }\n\n  const dataset = client.clientConfig.dataset\n  try {\n    const res = await client.request<{data: {id: string; created_at: string}}>({\n      url: `/addons/mux/signing-keys/${dataset}/${signingKeyId}`,\n      withCredentials: true,\n      method: 'GET',\n    })\n    //\n    // if this signing key is valid it will return { data: { id: 'xxxx' } }\n    //\n    return !!(res.data && res.data.id)\n  } catch (e) {\n    console.error('Error fetching signingKeyId', signingKeyId, 'assuming it is not valid')\n    return false\n  }\n}\n\nexport function testSecretsObservable() {\n  const dataset = client.clientConfig.dataset\n  return defer(() =>\n    client.observable.request<{status: boolean}>({\n      url: `/addons/mux/secrets/${dataset}/test`,\n      withCredentials: true,\n      method: 'GET',\n    })\n  )\n}\n"],"mappings":"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"}